<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Nikki's Monochro Maze</title>
    <style>
        body { background: #000; color: #eee; font-family: 'Courier New', Courier, monospace; display: flex; flex-direction: column; align-items: center; margin: 0; overflow: hidden; height: 100vh; }
        #canvas-container { position: relative; border: 4px solid #444; margin-top: 20px; }
        canvas { background: #111; display: block; }
        #ui { position: absolute; top: 10px; left: 10px; font-family: sans-serif; pointer-events: none; color: #ccc; }
        #msg-box { width: 380px; height: 80px; background: #222; border: 2px solid #eee; margin-top: 10px; padding: 10px; font-size: 14px; line-height: 1.6; overflow-y: auto; text-align: left; }
        .stats { margin-top: 10px; font-size: 16px; color: #aaa; }
    </style>
</head>
<body>
    <div class="stats">カラーコードの記憶: <span id="color-memories">0</span>/3</div>
    <div id="canvas-container">
        <div id="ui">ニッキのモノクロ迷宮 (矢印キー移動, Zキー: パワードスーツ脱/着, Xキー: スイッチ)</div>
        <canvas id="gameCanvas"></canvas>
    </div>
    <div id="msg-box">ここはモノクロの世界。失われた「色」の記憶を探し、出口を見つけよう。</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const msgBox = document.getElementById('msg-box');
        const colorMemoriesEl = document.getElementById('color-memories');

        canvas.width = 400; canvas.height = 400;
        const TILE = 40;

        // マップデータ (1:壁, 0:通路, S:スイッチ, D:扉(初期は閉), C:カラーコードの記憶, G:ゴール)
        // 扉はD1,D2のように番号を振る。スイッチもS1,S2のように対応させる
        const map = [
            [1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,1,0,C,0,0,1], /* カラーコード1 */
            [1,0,1,0,1,0,1,1,0,1],
            [1,0,1,S1,0,0,0,1,0,1], /* スイッチ1 */
            [1,0,1,1,1,1,0,1,0,1],
            [1,C,0,0,0,1,0,0,0,1], /* カラーコード2 */
            [1,1,1,1,0,D1,1,1,0,1], /* 扉1 */
            [1,0,0,0,0,0,0,1,0,1],
            [1,0,1,C,1,1,0,0,G,1], /* カラーコード3とゴール */
            [1,1,1,1,1,1,1,1,1,1]
        ];

        let player = { x: 1, y: 1, inSuit: true, colorMemories: 0 }; // inSuit: パワードスーツを着ているか
        const goal = {x: 8, y: 8};

        let doors = {
            'D1': { x: 5, y: 6, isOpen: false } // D1扉の位置と状態
        };

        function logMessage(text) {
            msgBox.innerHTML = text + "<br>" + msgBox.innerHTML;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for(let y=0; y<map.length; y++) {
                for(let x=0; x<map[y].length; x++) {
                    const tile = map[y][x];
                    let fillStyle = '#111'; // デフォルトは通路

                    if(tile === 1) fillStyle = '#444'; // 壁
                    else if(tile === 'C') fillStyle = '#777'; // カラーコード
                    else if(tile === 'S1') fillStyle = '#555'; // スイッチ
                    else if(tile === 'D1') fillStyle = doors.D1.isOpen ? '#111' : '#666'; // 扉
                    else if(tile === 'G') fillStyle = '#888'; // ゴール

                    ctx.fillStyle = fillStyle;
                    ctx.fillRect(x*TILE, y*TILE, TILE, TILE);

                    // スイッチやゴール、記憶の表現（目への刺激）
                    if (tile === 'S1') {
                        ctx.fillStyle = '#bbb'; // スイッチは明るく
                        ctx.fillRect(x*TILE + 10, y*TILE + 20, 20, 10);
                        if (doors.D1.isOpen) { ctx.fillStyle = '#2ed573'; ctx.fillRect(x*TILE + 10, y*TILE + 15, 20, 5); } // 押されたら緑
                    } else if (tile === 'G') {
                        ctx.fillStyle = '#eee'; // ゴールは白く
                        ctx.beginPath();
                        ctx.arc(x*TILE + TILE/2, y*TILE + TILE/2, TILE/4, 0, Math.PI*2);
                        ctx.fill();
                    } else if (tile === 'C') {
                        ctx.fillStyle = '#bbb'; // 記憶も白く
                        ctx.fillRect(x*TILE + 15, y*TILE + 15, 10, 10);
                    }
                }
            }

            // プレイヤーの描画 (ニッキ)
            if (player.inSuit) {
                ctx.fillStyle = '#bbb'; // スーツは灰色
                ctx.fillRect(player.x*TILE + 5, player.y*TILE + 5, 30, 30);
                ctx.fillStyle = '#eee'; // コックピット窓
                ctx.fillRect(player.x*TILE + 12, player.y*TILE + 8, 16, 12);
            } else {
                ctx.fillStyle = '#eee'; // ニッキは白猫
                ctx.beginPath();
                ctx.arc(player.x*TILE + TILE/2, player.y*TILE + TILE/2, TILE/4, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = '#000'; // 目
                ctx.beginPath();
                ctx.arc(player.x*TILE + TILE/2 - 5, player.y*TILE + TILE/2 - 2, 2, 0, Math.PI*2);
                ctx.arc(player.x*TILE + TILE/2 + 5, player.y*TILE + TILE/2 - 2, 2, 0, Math.PI*2);
                ctx.fill();
            }
        }

        window.addEventListener('keydown', e => {
            let nx = player.x, ny = player.y;
            let moved = false;

            if(e.key === 'ArrowUp') { ny--; moved = true; }
            else if(e.key === 'ArrowDown') { ny++; moved = true; }
            else if(e.key === 'ArrowLeft') { nx--; moved = true; }
            else if(e.key === 'ArrowRight') { nx++; moved = true; }
            else if(e.key === 'z') { // Zキーでパワードスーツ脱/着
                if (map[player.y][player.x] === 1) { // 壁の中では脱げない
                    logMessage("壁の中ではスーツを脱げない...");
                    return;
                }
                player.inSuit = !player.inSuit;
                logMessage(`パワードスーツを${player.inSuit ? '着た' : '脱いだ'}。`);
                draw();
                return;
            }
            else if(e.key === 'x') { // Xキーでスイッチを押す（または調べる）
                const currentTile = map[player.y][player.x];
                if (currentTile === 'S1') {
                    if (!doors.D1.isOpen) {
                        doors.D1.isOpen = true;
                        map[doors.D1.y][doors.D1.x] = 0; // 扉を開く
                        logMessage("スイッチが押された！どこかの扉が開いたようだ。");
                    } else {
                        logMessage("スイッチは既に押されている。");
                    }
                } else {
                    logMessage("何も起こらない...");
                }
                draw();
                return;
            }

            // 移動処理
            if (moved) {
                const targetTile = map[ny][nx];

                // スーツを脱いでいると入れない場所を作る（小ささの表現）
                // 例: D1扉の場所はスーツを脱いでいないと大きくて通れない
                if (!player.inSuit && targetTile === 'D1' && !doors.D1.isOpen) {
                    logMessage("ニッキでは通れない...パワードスーツが必要か？");
                    return;
                }


                if(targetTile === 1 || (targetTile === 'D1' && !doors.D1.isOpen)) { // 壁または閉じた扉
                    logMessage("壁だ。進めない...");
                    return; // 移動不可
                }
                
                player.x = nx; player.y = ny; // 移動実行

                // カラーコードの記憶回収 (小説要素)
                if(targetTile === 'C') {
                    player.colorMemories++;
                    colorMemoriesEl.innerText = player.colorMemories;
                    const memoryStories = [
                        "最初の記憶: 「#FF0000」...それは情熱の赤。",
                        "二番目の記憶: 「#0000FF」...それは深い海の青。",
                        "最後の記憶: 「#00FF00」...それは生命の緑。世界に色が戻る兆しを感じる..."
                    ];
                    logMessage("★ " + memoryStories[player.colorMemories - 1]);
                    map[ny][nx] = 0; // 回収済みにする
                }
            }

            // ゴール判定
            if(player.x === goal.x && player.y === goal.y) {
                if(player.colorMemories >= 3) {
                    alert('おめでとう！全ての色の記憶を取り戻し、モノクロの迷宮を抜け出した！');
                    location.reload();
                } else {
                    logMessage("出口は開かない。まだ全ての色の記憶が揃っていないようだ。");
                }
            }
            draw();
        });

        draw(); // 初回描画
        logMessage("矢印キーで移動。Zキーでパワードスーツ脱/着。Xキーでスイッチ操作。");
    </script>
</body>
</html>
