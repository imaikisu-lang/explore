<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>GATO ROBOT CONTROL CORE</title>
<style>
html,body{
  margin:0;
  background:#000;
}
canvas{
  display:block;
  margin:auto;
  background:#000;
}
</style>
</head>
<body>

<canvas id="c" width="640" height="360"></canvas>

<script>
/* ===============================
   固定タイムステップ設定
================================ */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const FIXED_DT = 1000 / 60;
let accumulator = 0;
let lastTime = performance.now();

/* ===============================
   入力システム（完全版）
================================ */
const Input = {
  left:false,
  right:false,
  jump:false,

  jumpPressed:false,
  jumpBuffer:0
};

addEventListener("keydown",e=>{
  if(e.code==="ArrowLeft") Input.left = true;
  if(e.code==="ArrowRight") Input.right = true;

  if(e.code==="KeyZ"){
    if(!Input.jump){
      Input.jumpPressed = true;
      Input.jumpBuffer = 6; // ★ジャンプバッファ
    }
    Input.jump = true;
  }
});

addEventListener("keyup",e=>{
  if(e.code==="ArrowLeft") Input.left = false;
  if(e.code==="ArrowRight") Input.right = false;
  if(e.code==="KeyZ") Input.jump = false;
});

/* ===============================
   マップ
================================ */
const TILE = 32;
const map = [
"############################",
"#..........................#",
"#..........................#",
"#..........######..........#",
"#..........................#",
"#..........................#",
"#......##########..........#",
"#..........................#",
"#..........................#",
"############################"
];

/* ===============================
   プレイヤー（GATO仕様）
================================ */
const player = {
  x:64,
  y:64,
  vx:0,
  vy:0,
  w:16,
  h:16,

  onGround:false,
  coyote:0 // ★地面猶予
};

/* ===============================
   定数（完全再現値）
================================ */
const SPEED = 2.75;
const GRAVITY = 0.65;
const JUMP_VEL = -9.2;
const COYOTE_FRAMES = 6;

/* ===============================
   衝突
================================ */
function solid(px,py){
  const tx = Math.floor(px/TILE);
  const ty = Math.floor(py/TILE);
  if(ty<0||ty>=map.length||tx<0||tx>=map[0].length) return true;
  return map[ty][tx]==="#";
}

/* ===============================
   物理更新（固定）
================================ */
function fixedUpdate(){

  /* ---- 入力バッファ減衰 ---- */
  if(Input.jumpBuffer > 0) Input.jumpBuffer--;

  /* ---- 左右：即時 ---- */
  player.vx = 0;
  if(Input.left) player.vx = -SPEED;
  if(Input.right) player.vx = SPEED;

  /* ---- ジャンプ判定 ---- */
  if(Input.jumpBuffer > 0 && player.coyote > 0){
    player.vy = JUMP_VEL;
    player.coyote = 0;
    Input.jumpBuffer = 0;
  }

  /* ---- 重力 ---- */
  player.vy += GRAVITY;

  /* ---- X移動 ---- */
  player.x += player.vx;
  if(
    solid(player.x,player.y) ||
    solid(player.x+player.w,player.y) ||
    solid(player.x,player.y+player.h) ||
    solid(player.x+player.w,player.y+player.h)
  ){
    player.x -= player.vx;
  }

  /* ---- Y移動 ---- */
  player.y += player.vy;
  if(
    solid(player.x,player.y+player.h) ||
    solid(player.x+player.w,player.y+player.h)
  ){
    player.y = Math.floor((player.y+player.h)/TILE)*TILE-player.h;
    player.vy = 0;
    player.onGround = true;
    player.coyote = COYOTE_FRAMES;
  }else{
    player.onGround = false;
    if(player.coyote > 0) player.coyote--;
  }
}

/* ===============================
   描画
================================ */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle="#444";
  for(let y=0;y<map.length;y++){
    for(let x=0;x<map[y].length;x++){
      if(map[y][x]==="#"){
        ctx.strokeRect(x*TILE,y*TILE,TILE,TILE);
      }
    }
  }

  ctx.fillStyle="#eee";
  ctx.fillRect(player.x,player.y,player.w,player.h);
}

/* ===============================
   メインループ
================================ */
function loop(now){
  accumulator += now - lastTime;
  lastTime = now;

  while(accumulator >= FIXED_DT){
    fixedUpdate();
    accumulator -= FIXED_DT;
  }

  draw();
  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>

</body>
</html>




